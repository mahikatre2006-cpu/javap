<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Parking App — History</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body {
    background: linear-gradient(135deg, #0a1a35 0%, #0a0a1a 50%, #000000 100%);
    background-attachment: fixed;
    min-height: 100vh;
  }
</style>
</head>
<body class="min-h-screen p-4">

<div class="max-w-4xl mx-auto">
  <header class="flex justify-between items-center mb-4">
    <a id="back-button" href="floors.html" class="text-blue-400 font-semibold px-2 py-1 border border-gray-600 rounded hover:bg-gray-800 transition-colors">← Back</a>
    <h1 class="text-xl font-bold text-white">Your Reservation History</h1>
    <button class="text-red-400 font-semibold px-2 py-1 border border-gray-600 rounded hover:bg-gray-800 transition-colors" onclick="doLogout()">Logout</button>
  </header>

  <main id="history-list" class="space-y-3"></main>
</div>

<script>
    const currentUser = localStorage.getItem('currentUser');
    if (!currentUser) {
        window.location.href = 'index.html';
    }

    function doLogout() { 
        localStorage.removeItem('currentUser');
        window.location.href = 'index.html'; 
    }

    // Helper function to format dates to be more readable
    function formatDate(dateString) {
        const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
        return new Date(dateString).toLocaleDateString('en-US', options);
    }

    async function renderHistory() {
        const container = document.getElementById('history-list');
        container.innerHTML = '<div class="bg-gray-800 p-6 text-gray-300 text-center">Loading history...</div>';

        // SIMPLIFIED: Using a hardcoded user ID. A real app would get this dynamically.
        // We're using the ID for the 'admin' user we created at the start.
        const userId = 1;

        try {
            const response = await fetch(`http://localhost:8081/api/reservations/user/${userId}`);
            if (!response.ok) {
                throw new Error('Failed to fetch history');
            }
            const history = await response.json();

            container.innerHTML = ''; // Clear loading message

            if (history.length === 0) { 
                container.innerHTML = '<div class="bg-gray-800 p-6 rounded-lg shadow text-gray-300 text-center">You have no reservation history.</div>'; 
                return; 
            }

            // Sort history from newest to oldest
            history.sort((a, b) => new Date(b.startTime) - new Date(a.startTime));

            history.forEach(item => {
                const card = document.createElement('div');
                card.className = 'bg-gray-800 bg-opacity-70 p-4 rounded-lg shadow';
                
                // The data from the backend is nested, so we access it like item.parkingSlot.floorNumber
                card.innerHTML = `
                    <div>
                        <div class="font-medium text-green-400">RESERVED</div>
                        <div class="text-sm text-gray-300 mt-1">
                            Floor ${item.parkingSlot.floorNumber} • Slot ${item.parkingSlot.slotNumber}
                        </div>
                        <div class="text-sm text-gray-400 mt-1">Vehicle: ${item.vehicleNumber}</div>
                        <div class="text-sm text-gray-400 mt-1">${formatDate(item.startTime)} → ${formatDate(item.endTime)}</div>
                    </div>
                `;
                container.appendChild(card);
            });

        } catch (error) {
            console.error("Error fetching history:", error);
            container.innerHTML = '<div class="bg-red-800 p-6 text-white text-center">Could not load history from server.</div>';
        }
    }

    // Run the function when the page loads
    renderHistory();
</script>
</body>
</html>